# Room
hemma_room:
  class: "hemma-room"
  template:
    - hemma_default
    - hemma_shared

  triggers_update:
    - '[[[ return variables.motion_sensor ]]]'
    - '[[[ return variables.temp_sensor ]]]'
    - '[[[ return variables.quality_sensor ]]]'
    - '[[[ return variables.humidity_sensor ]]]'
    - '[[[ return variables.presence_entity_1 ]]]'
    - '[[[ return variables.presence_entity_2 ]]]'
    - '[[[ return variables.media_player_1 ]]]'
    - '[[[ return variables.media_player_2 ]]]'
    - '[[[ return variables.media_player_3 ]]]'
    - '[[[ return variables.media_player_4 ]]]'
    - '[[[ return variables.psn_1 ]]]'
    - '[[[ return variables.psn_2 ]]]'
    - '[[[ return variables.media_plex_binary ]]]'
    - '[[[ return variables.media_plex_session ]]]'
    - input_boolean.hemma_mobile_navigation

  variables:
    image:
    image_position:

    show_quality: false
    quality_sensor:

    show_humidity: false
    humidity_sensor:

    show_temp: false
    temp_sensor:

    show_motion: false
    motion_sensor:

    show_presence: false
    presence_entity_1:
    presence_entity_2:

    show_media_badge: false

    show_media_player_1: false
    media_player_1:

    show_media_player_2: false
    media_player_2:

    show_media_player_3: false
    media_player_3:

    show_media_player_4: false
    media_player_4:

    show_media_plex: false
    media_plex_binary:
    media_plex_session:

    show_psn_1: false
    psn_1:

    show_psn_2: false
    psn_2:

    _hemma_mp_styles: !include /config/dashboards/templates/includes/hemma_media_player_styles.yaml

  tap_action: { action: none }
  hold_action: { action: none }
  double_tap_action: { action: none }

  styles:
    card:
      - height: 100svh
      - padding-top: var(--hero-top)
      - padding-left: var(--hero-gutter)
      - padding-right: var(--hero-gutter)
      - padding-bottom: calc(130px + env(safe-area-inset-bottom))
      - box-shadow: none !important
      - transform: translateZ(0)
      - will-change: transform
      - --hero-img: >
          [[[
            const img = variables.image || 'default';
            const url = `/local/hemma/rooms/${img}.jpg`;
            return `url("${url}")`;
          ]]]
      - --hero-img-pos: >
          [[[
            return variables.image_position || 'center center';
          ]]]
      - --hemma-time-right: >
          [[[
            const w = window?.innerWidth || 1024;
            const h = window?.innerHeight || 800;
            const isTablet = (w >= 768 && w <= 1249 && h > 500);
            return isTablet ? 'calc(var(--hero-gutter) - 20px)' : 'var(--hemma-nav-margin-current, 4vw)';
          ]]]

    name:
      - grid-area: n
      - color: var(--primary-text-color)
      - opacity: 0.9
      - font-size: var(--hero-room-name-size-current, clamp(48px, 6vw + 12px, 100px))
      - letter-spacing: var(--hero-room-name-letter-spacing-current, -2px)
      - font-weight: 700
      - justify-self: start
      - padding-left: 0
      - line-height: var(--hero-room-name-line-height-current, 1.2)
      - margin-left: var(--hero-room-name-margin-left-current, 0px)
      - overflow: visible

    grid:
      - grid-template-columns: 1fr
      - grid-template-areas: |
          "temperature"
          "n"
          "badges"
          "badges_media"
      - grid-template-rows: >
          [[[
            const reserve = 'var(--hero-temp-reserve, 22px)';
            return `minmax(${reserve}, min-content) min-content min-content min-content`;
          ]]]
      - row-gap: var(--hero-header-gap-current, 6px)
      - align-content: start

    custom_fields:
      motion_detection:
        - display: >
            [[[
              return variables.show_motion && variables.motion_sensor ? 'block' : 'none';
            ]]]
        - position: fixed
        - right: 0
        - left: 0
        - bottom: 0
        - transform: >
            [[[
              return states[variables.motion_sensor]?.state === 'on'
                ? 'translateY(0)'
                : 'translateY(100%)';
            ]]]
        - transition: transform 0.5s
        - padding: 20px
        - color: white
        - font-size: 13px
        - text-transform: uppercase
        - letter-spacing: 2px
        - font-weight: 700
        - background: rgba(255,255,255,0.1)
        - backdrop-filter: blur(12px)
        - z-index: 999

      temperature:
        - display: >
            [[[
              const navOpen = states['input_boolean.hemma_mobile_navigation']?.state === 'on';
              return navOpen ? 'none' : 'block';
            ]]]
        - visibility: >
            [[[
              const has = variables.show_temp && variables.temp_sensor && states[variables.temp_sensor];
              return has ? 'visible' : 'hidden';
            ]]]
        - min-height: var(--hero-temp-reserve, 22px)
        - color: var(--primary-text-color)
        - opacity: 0.9
        - justify-self: start
        - margin: 0
        - padding-left: 0
        - margin-left: >
            calc(
              var(--hero-room-name-margin-left-current, 0px) +
              var(--hemma-header-temp-nudge, 0px))
        - font-size: var(--hero-temp-font-size, var(--hero-temp-font-size-desktop, 16px))
        - "--button-card-ripple-color": transparent
        - "-webkit-tap-highlight-color": transparent

      time:
        - position: fixed
        - top: >
            [[[
              const w = window?.innerWidth || 1024;
              const h = window?.innerHeight || 800;

              const isMobile = (w <= 767 || h <= 500);
              const isTablet = (w >= 768 && w <= 1249 && h > 500);

              const nudge =
                isMobile ? 'var(--hemma-time-nudge-mobile, 8px)' :
                isTablet ? 'var(--hemma-time-nudge-tablet, 36px)' :
                '0px';

              return `calc(env(safe-area-inset-top, 0px) + var(--hemma-nav-top-current, 46px) - ${nudge})`;
            ]]]
        - right: >
            [[[
              return `var(--hemma-time-right, var(--hemma-nav-margin-current, 4vw))`;
            ]]]
        - z-index: 10
        - pointer-events: auto
        - "--mdc-ripple-press-opacity": 0
        - "-webkit-tap-highlight-color": transparent
        - display: >
            [[[
              const navOpen = states['input_boolean.hemma_mobile_navigation']?.state === 'on';
              const mm = (q) => (window.matchMedia ? window.matchMedia(q).matches : false);
              const isTouch = mm('(pointer: coarse)') || mm('(hover: none)');
              const w = window?.innerWidth || 1024;
              const h = window?.innerHeight || 800;
              const isTablet = (w >= 768 && w <= 1249 && h > 500);
              return (!navOpen && isTouch && isTablet) ? 'block' : 'none';
            ]]]

      badges:
        - grid-area: badges
        - justify-self: start !important
        - align-self: start !important
        - place-self: start !important
        - text-align: left !important
        - margin-left: >
            calc(
              var(--hero-room-name-margin-left-current, 0px) +
              var(--hemma-header-badge-nudge, 0px)) !important
        - margin-right: auto !important
        - width: max-content
        - max-width: 100%
        - margin-top: 0
        - margin-bottom: 0
        - padding-left: 0
        - pointer-events: auto
        - display: >
            [[[
              return (states['input_boolean.hemma_mobile_navigation']?.state === 'on')
                ? 'none'
                : 'block';
            ]]]

      badges_media:
        - grid-area: badges_media
        - justify-self: start !important
        - align-self: start !important
        - place-self: start !important
        - text-align: left !important
        - margin-top: var(--badge-media-gap, 0px)
        - margin-right: auto !important
        - margin-left: >
            calc(
              var(--hero-room-name-margin-left-current, 0px) +
              var(--hemma-header-badge-nudge, 0px)) !important
        - padding-left: 0
        - padding-top: 0px
        - padding-bottom: 0px
        - width: "min(var(--badge-media-max-width-current, 640px), 100%)"
        - max-width: 100%
        - pointer-events: auto
        - display: >
            [[[
              const navOpen = states['input_boolean.hemma_mobile_navigation']?.state === 'on';

              const anyMp =
                (variables.show_media_player_1 && variables.media_player_1) ||
                (variables.show_media_player_2 && variables.media_player_2) ||
                (variables.show_media_player_3 && variables.media_player_3) ||
                (variables.show_media_player_4 && variables.media_player_4);

              const anyOther =
                (variables.show_media_badge) ||
                anyMp ||
                (variables.show_media_plex && variables.media_plex_binary) ||
                (variables.show_psn_1 && variables.psn_1) ||
                (variables.show_psn_2 && variables.psn_2);

              return (!navOpen && anyOther) ? 'block' : 'none';
            ]]]

      navigation:
        - position: absolute
        - top: "-8px"
        - left: 0
        - right: 0
        - "--mdc-ripple-press-opacity": 0
        - "-webkit-tap-highlight-color": transparent
        - filter: none
        - pointer-events: auto

      menu:
        - position: fixed
        - top: 8px
        - left: >
            [[[
              const w = window?.innerWidth || 1024;
              const h = window?.innerHeight || 800;

              if (w <= 767 || h <= 500) {
                return 'calc(var(--hero-gutter) - 11px)';
              }

              return 'calc(var(--hero-gutter) - 6px)';
            ]]]
        - width: 40px
        - height: 40px
        - z-index: 10
        - pointer-events: auto
        - cursor: pointer

  custom_fields:
    menu:
      card:
        type: custom:button-card
        template: hemma_menu_icon

    navigation:
      card: !include /config/dashboards/templates/includes/hemma_navigation.yaml

    temperature: |
      [[[
        const navOpen = states['input_boolean.hemma_mobile_navigation']?.state === 'on';
        if (navOpen) return '';

        const has = variables.show_temp && variables.temp_sensor && states[variables.temp_sensor];
        if (!has) return '&nbsp;';

        const vRaw = states[variables.temp_sensor].state;
        const v = Number(vRaw);
        if (Number.isNaN(v)) return '&nbsp;';

        const t = Math.round(v);

        let label = 'Very Hot';
        if (v <= 64.99)      label = 'Very Cold';
        else if (v <= 69.99) label = 'Cool';
        else if (v <= 75.99) label = 'Comfortable';
        else if (v <= 80.99) label = 'Warm';
        else if (v <= 84.99) label = 'Hot';

        return `
          <div class="hero-temp-line">
            ${t}Â° - ${label.toUpperCase()}
          </div>
        `;
      ]]]

    time:
      card:
        type: custom:button-card
        template: hemma_time

    badges:
      card:
        type: custom:layout-card
        layout_type: custom:grid-layout

        card_mod:
          style: |
            :host{
              --layout-margin: 0px !important;
              --layout-padding: 0px !important;
            }

            ha-card{
              padding: 0 !important;
              margin: 0 !important;
              background: transparent !important;
              box-shadow: none !important;
              border-radius: 0 !important;
            }

        layout:
          grid-auto-flow: column
          grid-auto-columns: max-content
          grid-template-columns: none
          justify-content: start
          justify-items: start
          align-items: center
          grid-column-gap: var(--badge-gap-current, var(--badge-col-gap, 10px))

        cards:
          - type: custom:button-card
            template: hemma_badge_presence
            entity: '[[[ return variables.presence_entity_1 ]]]'
            variables:
              enabled: '[[[ return variables.show_presence ]]]'

          - type: custom:button-card
            template: hemma_badge_presence
            entity: '[[[ return variables.presence_entity_2 ]]]'
            variables:
              enabled: '[[[ return variables.show_presence ]]]'

          - type: custom:button-card
            template: hemma_badge_air_quality
            entity: '[[[ return variables.quality_sensor ]]]'
            variables:
              enabled: '[[[ return variables.show_quality ]]]'

          - type: custom:button-card
            template: hemma_badge_humidity
            entity: '[[[ return variables.humidity_sensor ]]]'
            variables:
              enabled: '[[[ return variables.show_humidity ]]]'

    badges_media:
      card:
        type: custom:layout-card
        layout_type: custom:grid-layout

        card_mod:
          style: |
            :host{
              --layout-margin: 0px !important;
              --layout-padding: 0px !important;
              --layout-height: auto !important;
              --layout-overflow: visible !important;
            }

            ha-card{
              padding: 0 !important;
              margin: 0 !important;
              background: transparent !important;
              box-shadow: none !important;
              border-radius: 0 !important;
            }

            #container{
              height: auto !important;
              align-items: start !important;
              align-content: start !important;
              justify-items: start !important;
              justify-content: start !important;
              text-align: left !important;
            }

        layout:
          grid-template-columns: 1fr
          grid-auto-flow: row
          grid-auto-rows: min-content
          grid-row-gap: 0px
          justify-items: start
          justify-content: start
          align-items: start
          align-content: start

        cards:

          # Media Player 1
          - type: custom:navbar-card
            desktop: { min_width: 1, hidden: false, show_labels: false, show_popup_label_backgrounds: false, mode: docked }
            mobile: { hidden: true }
            routes: []
            media_player:
              entity: '[[[ return variables.media_player_1 ]]]'
              show: |
                [[[
                  const eid = variables.media_player_1;
                  const enabled = variables.show_media_player_1 && eid;
                  if (!enabled) return false;

                  const s  = states[eid];
                  const st = s?.state;
                  const a  = s?.attributes || {};

                  if (st === 'playing' || st === 'buffering') return true;

                  if (st === 'paused') {
                    const title  = String(a.media_title || '').trim();
                    const artist = String(a.media_artist || a.artist || a.media_album_artist || '').trim();
                    const app    = String(a.app_name || a.source || '').trim();

                    const dur = Number(a.media_duration || 0);
                    const pos = Number(a.media_position || 0);

                    const badTitles = new Set(['idle', 'paused', 'unknown', 'unavailable']);
                    const titleKey = title.toLowerCase();

                    const hasText =
                      (title && !badTitles.has(titleKey) && title !== app) ||
                      !!artist;

                    const hasTimingDefault = (dur > 0) || (pos > 0);

                    const isYouTube =
                      String(a.app_id || '') === 'com.google.ios.youtube' ||
                      String(a.app_name || '').toLowerCase() === 'youtube';

                    if (isYouTube) {
                      const upd = a.media_position_updated_at;
                      const ageMs = upd ? (Date.now() - new Date(upd).getTime()) : 999999999;
                      const recent = ageMs < (3 * 60 * 1000); // 3 minutes

                      const hasTimingStrict = (dur > 0) && (pos > 0);
                      return hasText && hasTimingStrict && recent;
                    }

                    return hasText && hasTimingDefault;
                  }

                  return false;
                ]]]

              album_cover_background: true
              tap_action: { action: more-info, entity: '[[[ return variables.media_player_1 ]]]' }
              hold_action: { action: none }
            styles: '[[[ return variables._hemma_mp_styles ]]]'

          # Media Player 2
          - type: custom:navbar-card
            desktop: { min_width: 1, hidden: false, show_labels: false, show_popup_label_backgrounds: false, mode: docked }
            mobile: { hidden: true }
            routes: []
            media_player:
              entity: '[[[ return variables.media_player_2 ]]]'
              show: |
                [[[
                  const eid = variables.media_player_2;
                  const enabled = variables.show_media_player_2 && eid;
                  if (!enabled) return false;

                  const s  = states[eid];
                  const st = s?.state;
                  const a  = s?.attributes || {};

                  if (st === 'playing' || st === 'buffering') return true;

                  if (st === 'paused') {
                    const title  = String(a.media_title || '').trim();
                    const artist = String(a.media_artist || a.artist || a.media_album_artist || '').trim();
                    const app    = String(a.app_name || a.source || '').trim();

                    const dur = Number(a.media_duration || 0);
                    const pos = Number(a.media_position || 0);

                    const badTitles = new Set(['idle', 'paused', 'unknown', 'unavailable']);
                    const titleKey = title.toLowerCase();

                    const hasText =
                      (title && !badTitles.has(titleKey) && title !== app) ||
                      !!artist;

                    const hasTimingDefault = (dur > 0) || (pos > 0);

                    const isYouTube =
                      String(a.app_id || '') === 'com.google.ios.youtube' ||
                      String(a.app_name || '').toLowerCase() === 'youtube';

                    if (isYouTube) {
                      const upd = a.media_position_updated_at;
                      const ageMs = upd ? (Date.now() - new Date(upd).getTime()) : 999999999;
                      const recent = ageMs < (3 * 60 * 1000); // 3 minutes

                      const hasTimingStrict = (dur > 0) && (pos > 0);
                      return hasText && hasTimingStrict && recent;
                    }

                    return hasText && hasTimingDefault;
                  }

                  return false;
                ]]]

              album_cover_background: true
              tap_action: { action: more-info, entity: '[[[ return variables.media_player_2 ]]]' }
              hold_action: { action: none }
            styles: '[[[ return variables._hemma_mp_styles ]]]'

          # Media Player 3
          - type: custom:navbar-card
            desktop: { min_width: 1, hidden: false, show_labels: false, show_popup_label_backgrounds: false, mode: docked }
            mobile: { hidden: true }
            routes: []
            media_player:
              entity: '[[[ return variables.media_player_3 ]]]'
              show: |
                [[[
                  const eid = variables.media_player_3;
                  const enabled = variables.show_media_player_3 && eid;
                  if (!enabled) return false;

                  const s  = states[eid];
                  const st = s?.state;
                  const a  = s?.attributes || {};

                  if (st === 'playing' || st === 'buffering') return true;

                  if (st === 'paused') {
                    const title  = String(a.media_title || '').trim();
                    const artist = String(a.media_artist || a.artist || a.media_album_artist || '').trim();
                    const app    = String(a.app_name || a.source || '').trim();

                    const dur = Number(a.media_duration || 0);
                    const pos = Number(a.media_position || 0);

                    const badTitles = new Set(['idle', 'paused', 'unknown', 'unavailable']);
                    const titleKey = title.toLowerCase();

                    const hasText =
                      (title && !badTitles.has(titleKey) && title !== app) ||
                      !!artist;

                    const hasTimingDefault = (dur > 0) || (pos > 0);

                    const isYouTube =
                      String(a.app_id || '') === 'com.google.ios.youtube' ||
                      String(a.app_name || '').toLowerCase() === 'youtube';

                    if (isYouTube) {
                      const upd = a.media_position_updated_at;
                      const ageMs = upd ? (Date.now() - new Date(upd).getTime()) : 999999999;
                      const recent = ageMs < (3 * 60 * 1000); // 3 minutes

                      const hasTimingStrict = (dur > 0) && (pos > 0);
                      return hasText && hasTimingStrict && recent;
                    }

                    return hasText && hasTimingDefault;
                  }

                  return false;
                ]]]
              album_cover_background: true
              tap_action: { action: more-info, entity: '[[[ return variables.media_player_3 ]]]' }
              hold_action: { action: none }
            styles: '[[[ return variables._hemma_mp_styles ]]]'

          # Media Player 4
          - type: custom:navbar-card
            desktop: { min_width: 1, hidden: false, show_labels: false, show_popup_label_backgrounds: false, mode: docked }
            mobile: { hidden: true }
            routes: []
            media_player:
              entity: '[[[ return variables.media_player_4 ]]]'
              show: |
                [[[
                  const eid = variables.media_player_4;
                  const enabled = variables.show_media_player_4 && eid;
                  if (!enabled) return false;

                  const s  = states[eid];
                  const st = s?.state;
                  const a  = s?.attributes || {};

                  if (st === 'playing' || st === 'buffering') return true;

                  if (st === 'paused') {
                    const title  = String(a.media_title || '').trim();
                    const artist = String(a.media_artist || a.artist || a.media_album_artist || '').trim();
                    const app    = String(a.app_name || a.source || '').trim();

                    const dur = Number(a.media_duration || 0);
                    const pos = Number(a.media_position || 0);

                    const badTitles = new Set(['idle', 'paused', 'unknown', 'unavailable']);
                    const titleKey = title.toLowerCase();

                    const hasText =
                      (title && !badTitles.has(titleKey) && title !== app) ||
                      !!artist;

                    const hasTimingDefault = (dur > 0) || (pos > 0);

                    const isYouTube =
                      String(a.app_id || '') === 'com.google.ios.youtube' ||
                      String(a.app_name || '').toLowerCase() === 'youtube';

                    if (isYouTube) {
                      const upd = a.media_position_updated_at;
                      const ageMs = upd ? (Date.now() - new Date(upd).getTime()) : 999999999;
                      const recent = ageMs < (3 * 60 * 1000); // 3 minutes

                      const hasTimingStrict = (dur > 0) && (pos > 0);
                      return hasText && hasTimingStrict && recent;
                    }

                    return hasText && hasTimingDefault;
                  }

                  return false;
                ]]]
              album_cover_background: true
              tap_action: { action: more-info, entity: '[[[ return variables.media_player_4 ]]]' }
              hold_action: { action: none }
            styles: '[[[ return variables._hemma_mp_styles ]]]'

          # PlayStation
          - type: custom:button-card
            template: hemma_badge_activity
            entity: '[[[ return variables.psn_1 ]]]'
            variables:
              enabled: '[[[ return variables.show_psn_1 ]]]'

          - type: custom:button-card
            template: hemma_badge_activity
            entity: '[[[ return variables.psn_2 ]]]'
            variables:
              enabled: '[[[ return variables.show_psn_2 ]]]'

          # Plex
          - type: custom:button-card
            template: hemma_badge_plex
            entity: '[[[ return variables.media_plex_binary ]]]'
            variables:
              enabled: '[[[ return variables.show_media_plex ]]]'
              session_entity: '[[[ return variables.media_plex_session ]]]'

    motion_detection: |
      [[[
        return "Motion detected"
      ]]]
