# Media Card
hemma_media:
  show_empty: false
  template:
    - hemma_entity

  variables:
    icon: |
      [[[
        const id = entity?.entity_id || "";
        const type = entity?.attributes?.media_content_type || "";
        if (id.includes("apple_tv")) return "apple";
        if (id.includes("homepod")) return "apple";
        if (id.includes("spotify")) return "music";
        if (id.includes("playstation")) return "sony";
        if (type === "music") return "speaker";
        if (type === "video") return "tv";
        return "speaker";
      ]]]

  show_last_changed: false
  show_entity_picture: true
  show_icon: false

  state_display: |
    [[[
      const sRaw = String(entity?.state || "");
      const s    = sRaw.toLowerCase();
      const a    = entity?.attributes || {};
      const cap  = (x) => (x ? x.charAt(0).toUpperCase() + x.slice(1) : "");
      const esc  = (t) => String(t ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .trim();
      if (s === "playing") {
        const id       = entity?.entity_id || "";
        const friendly = (a.friendly_name || "").toLowerCase();
        const type   = String(a.media_content_type || "").toLowerCase();
        const title  = (a.media_title || a.title || "").trim();
        const artist =
          (a.media_artist || a.artist || a.media_album_artist || "").trim();
        const app    = (a.app_name || "").trim();
        const source = (a.source || a.media_channel || "").trim();
        const isMusic =
          type === "music" ||
          id.includes("spotify") ||
          (!!artist && !["movie","video","tvshow"].includes(type));
        let label = "";
        if (isMusic) {
          if (artist && title) label = `${artist} - ${title}`;
          else label = title || artist || app || source || cap(s);
        } else {
          label = title || app || source || cap(s);
        }
        const isSonos = id.includes("sonos") || friendly.includes("sonos");
        const bareInputs = ["tv","hdmi","arc","hdmi arc","optical","line-in","line in"];
        let looksLikeBareInput = false;
        if (isSonos) {
          const tLow = title.toLowerCase();
          const sLow = source.toLowerCase();
          if (
            title && (
              bareInputs.includes(tLow) ||
              (source && tLow === sLow)
            )
          ) {
            looksLikeBareInput = true;
          }
        }
        const hasRichMeta =
          !!(a.media_artist || a.media_album_artist || a.media_series_title || a.media_episode_title);
        const mediaTypes = ["music","movie","video","tvshow"];
        const fromRichApp =
          /youtube|plex|netflix|hulu|disney|max|prime|spotify|apple tv|apple music|paramount|peacock/i
            .test(app);
        const isRichPlayback = !looksLikeBareInput && (
          hasRichMeta ||
          mediaTypes.includes(type) ||
          fromRichApp
        );
        if (!isRichPlayback) return esc(label) || cap(s);
        return `<span class="hemma-media-state">${esc(label)}</span>`;
      }
      if (["off","idle","paused","standby","unavailable","unknown"].includes(s)) {
        return cap(s);
      }
      return s ? cap(s) : "Off";
    ]]]

  tap_action:
    action: more-info
  hold_action:
    action: more-info

  styles:
    grid:
      - grid-template-areas: |
          "i"
          "."
          "n"
          "s"
      - grid-template-columns: 1fr
      - grid-template-rows: min-content 1fr min-content min-content
      - row-gap: 4px
      - justify-items: start
      - align-items: start

    card:
      - background-size: cover
      - background-position: center
      - background-image: |
          [[[
            const isActive = ["playing","paused"].includes(String(entity?.state || "").toLowerCase());
            const pic = entity?.attributes?.entity_picture || "";
            if (isActive && pic) {
              const path = pic.startsWith("/") ? `${window.location.origin}${pic}` : pic;
              return `linear-gradient(rgba(70, 70, 70, 0.7), rgba(70, 70, 70, 0.7)), url('${path}')`;
            }
            return "none";
          ]]]

    name:
      - grid-area: n
      - align-self: end
      - z-index: 2

    state:
      - grid-area: s
      - align-self: start
      - z-index: 2
      - white-space: nowrap
      - overflow: hidden
      - text-overflow: ellipsis
