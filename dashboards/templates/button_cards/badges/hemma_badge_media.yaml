# Media
hemma_badge_media:
  template: [hemma_badge_base]
  show_state: false
  show_label: false
  tap_action: { action: more-info }
  hold_action: { action: more-info }

  styles:
    card:
      - box-shadow: none !important
      - width: fit-content
      - max-width: >
          [[[
            const mm = (q) => (window?.matchMedia?.(q)?.matches ?? false);
            if (mm('(min-width: 1024px)')) return 'none';

            // Cap to the same left/right "hero gutter" as your layout
            let g = 24;
            try {
              const v = getComputedStyle(document.documentElement).getPropertyValue('--hero-gutter').trim();
              const n = parseFloat(v);
              if (!Number.isNaN(n)) g = n;
            } catch(e){}
            return `calc(100vw - (${g}px * 2))`;
          ]]]
      - min-width: 0
      - overflow: hidden
      - justify-self: start
      - align-self: center
      - place-self: start
      - margin-inline-start: var(--badge-media-inset-start, var(--badge-rim-bleed, 6px))
      - margin-left: 0px
      - margin-block-end: 0px
      - min-height: "calc(var(--badge-min-height-current, var(--badge-min-height, 44px)) + 4px) !important"
      - --badge-rim-width: 1.4px
      - --badge-rim-alpha: 0.24
      - --badge-rim-glow: 0.12
      - display: >
          [[[
            // OPT-IN gate: if enabled isn't explicitly true, hide.
            const enabled =
              (variables?.enabled === true) ||
              (variables?.enabled === 'true') ||
              (variables?.enabled === 'True') ||
              (variables?.enabled === 1) ||
              (variables?.enabled === '1');

            if (!enabled) return 'none';

            const s = String(entity?.state || '').toLowerCase();
            const a = entity?.attributes || {};

            if (s === 'playing' || s === 'buffering') return 'inline-grid';

            if (s === 'paused') {
              const norm = (v) => String(v || '').trim();
              const title   = norm(a.media_title || a.title);
              const artist  = norm(a.media_artist || a.artist || a.media_album_artist);
              const album   = norm(a.media_album_name);
              const series  = norm(a.media_series_title);
              const channel = norm(a.media_channel);

              const bad = (v) => {
                const x = String(v || '').toLowerCase().trim();
                return !x || ['paused','idle','unknown','unavailable','none','-'].includes(x);
              };

              const meaningful =
                (!bad(title)) || (!bad(artist)) || (!bad(album)) || (!bad(series)) || (!bad(channel));

              return meaningful ? 'inline-grid' : 'none';
            }

            return 'none';
          ]]]
      - --bg-url: >
          [[[
            const cacheKey = '_homBgUrl';
            const a = entity?.attributes || {};
            const v = variables || {};
            const pref =
              a.entity_picture_local ||
              a.entity_picture ||
              a.media_image_url ||
              v.bg_url;

            if (pref) {
              const url = String(pref).startsWith('/')
                ? `${location.origin}${pref}`
                : pref;
              const wrapped = `url("${url}")`;
              this[cacheKey] = wrapped;
              return wrapped;
            }
            return this[cacheKey] || 'none';
          ]]]
      - --anim-play: running

    grid:
      - grid-template-columns: min-content minmax(0, auto)

  icon: >
    [[[
      const s  = String(entity?.state || '').toLowerCase();
      const a  = entity?.attributes || {};
      const id = String(entity?.entity_id || '').toLowerCase();
      const t  = String(a.media_content_type || '').toLowerCase();
      const src = String(a.source || a.app_name || '').toLowerCase();

      if (s === 'paused') return 'mdi:pause';

      if (t === 'game' || id.includes('psn_') || src.includes('playstation')) return 'mdi:sony-playstation';
      if (id.includes('spotify') || t === 'music') return 'mdi:music-note';
      if (t === 'video') return 'mdi:television-play';

      return 'mdi:cast-audio';
    ]]]

  name: >
    [[[
      const a = entity?.attributes || {};
      const s = String(entity?.state || '').toLowerCase();
      const cap = x => x ? x.charAt(0).toUpperCase() + x.slice(1) : '';
      const friendly = a.friendly_name || 'Media';
      const type     = String(a.media_content_type || '').toLowerCase();

      const title    = (a.media_title || a.title || '').trim();
      const artist   = (a.media_artist || a.artist || a.media_album_artist || '').trim();
      const series   = (a.media_series_title || '').trim();
      const channel  = (a.media_channel || '').trim();
      const app      = (a.app_name || '').trim();

      let sub = cap(s || 'Off');
      if (['playing','paused','buffering'].includes(s)) {
        sub = (type === 'music')
          ? ((artist && title) ? `${artist} - ${title}` : (artist || title || cap(s)))
          : (series || title || channel || app || cap(s));
      }

      const esc = (sub || '').replaceAll('"','&quot;');

      const mm = (q) => (window?.matchMedia?.(q)?.matches ?? false);
      const isMobilePortrait = mm('(max-width: 767px) and (orientation: portrait)');

      // Compute available px (viewport - gutters*2 - fudge)
      let g = 24;
      try {
        const v = getComputedStyle(document.documentElement).getPropertyValue('--hero-gutter').trim();
        const n = parseFloat(v);
        if (!Number.isNaN(n)) g = n;
      } catch(e){}

      const tv = (k, d) => Number(variables?.[k] ?? hass?.themes?.theme_variables?.[k] ?? d);
      const fontPx  = tv('media_title_px', 12);
      const weight  = '600';
      const fudgePx = tv('media_marquee_fudge_px', 96);

      const availPx = Math.max(0, (window?.innerWidth || 375) - (g * 2) - fudgePx);

      let textPx = 0;
      try {
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        ctx.font = `${weight} ${fontPx}px Hanken Grotesk, system-ui, -apple-system, Segoe UI, Roboto, sans-serif`;
        textPx = ctx.measureText(sub).width;
      } catch(e){}

      const shouldScroll = isMobilePortrait && (textPx > availPx);

      // Two copies for seamless loop
      const inner =
        `<span class="m__inner" data-text="${esc}">${esc}</span>` +
        `<span class="m__inner" data-text="${esc}">${esc}</span>`;

      return `
        <div class="media-wrap">
          <div class="media-top">${friendly}</div>

          <div class="mwrap ${shouldScroll ? 'm--scroll' : ''}">
            <div class="m ${shouldScroll ? 'm__run' : ''}">
              ${inner}
            </div>
          </div>

          <div class="sub--static" data-text="${esc}">${esc}</div>
        </div>
      `;
    ]]]

  custom_fields:
    ic: >
      [[[
        const s = String(entity?.state || '').toLowerCase();
        if (s !== 'playing') return '';
        return `
          <div class="eq" aria-hidden="true">
            <span class="b b1"></span>
            <span class="b b2"></span>
            <span class="b b3"></span>
            <span class="b b4"></span>
          </div>
        `;
      ]]]

  state:
    - value: playing
      styles:
        icon: [display: none]
        custom_fields:
          ic: [display: block]
        card:
          - --badge-rim-glow: .10
          - --media-sub-opacity: .86

    - value: paused
      styles:
        icon: [display: block]
        custom_fields:
          ic: [display: none]
        card:
          - --anim-play: paused
          - --badge-rim-glow: .02
          - --media-sub-opacity: .75

    - value: buffering
      styles:
        icon: [display: block]
        custom_fields:
          ic: [display: none]

  extra_styles: |
    .media-wrap{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      min-width:0;
      max-width:100%;
    }

    .media-top{
      font-size:var(--badge-font-size-current,13px);
      font-weight:700;
      color:var(--primary-text-color);
      min-width:0;
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:clip;
      line-height:1.2;
    }

    .sub--static{
      display:block;
      font-size: var(--media-title-size);
      line-height: var(--media-title-line-height);
      white-space: nowrap;
      min-width: 0;
      max-width: 100%;
      overflow: hidden;
      text-overflow: clip;
    }

    .mwrap{ display:none; }
    .m--scroll{ display:block; }
    .m--scroll + .sub--static{ display:none; }

    .mwrap{
      width:100%;
      min-width:0;
      overflow:hidden;
      line-height: var(--media-title-line-height);
      height: var(--media-title-line-height);
      -webkit-mask-image: linear-gradient(to right, transparent 0, #000 18px, #000 calc(100% - 18px), transparent 100%);
              mask-image: linear-gradient(to right, transparent 0, #000 18px, #000 calc(100% - 18px), transparent 100%);
      font-size: var(--media-title-size);
    }

    .m{
      display:flex;
      width:max-content;
      will-change: transform;
      white-space: nowrap;
      min-width:0;
    }

    .m__inner{
      white-space: nowrap;
      padding-right: var(--media-marquee-gap);
    }

    .m__run{
      animation: media-marquee var(--media-marquee-speed) linear infinite;
    }

    :host(:focus-within) .m__run{ animation-play-state: paused; }

    @media (prefers-reduced-motion: reduce){
      .m__run{ animation: none !important; transform: translateX(0) !important; }
    }

    @keyframes media-marquee{
      from{ transform: translateX(0); }
      to  { transform: translateX(-50%); }
    }

    #ic{
      grid-area:i !important;
      display:grid !important;
      place-items:center center !important;
      width:var(--badge-icon-size-current, var(--badge-icon-size,28px)) !important;
      height:var(--badge-icon-size-current, var(--badge-icon-size,28px)) !important;
      padding-left:0 !important;
      box-sizing:border-box;
      z-index:4;
    }
    #ic > .eq{
      width:calc(var(--badge-icon-size-current, var(--badge-icon-size,28px))*.88);
      height:calc(var(--badge-icon-size-current, var(--badge-icon-size,28px))*.88);
      display:grid;
      grid-auto-flow:column;
      align-items:center;
      justify-content:center;
      column-gap:3px;
    }
    .eq .b{
      width:3px;
      height:100%;
      background:var(--primary-text-color);
      border-radius:999px;
      transform-origin:50% 50%;
      transform:scaleY(.35);
      animation:eq-center 1200ms ease-in-out infinite;
    }
    .eq .b1{ --sy-min:.25; --sy-max:.45; animation-delay:-2.2s; }
    .eq .b2{ --sy-min:.35; --sy-max:.70; animation-delay:-1.6s; }
    .eq .b3{ --sy-min:.55; --sy-max:.85; animation-delay:-0.8s; }
    .eq .b4{ --sy-min:.25; --sy-max:.45; animation-delay:-0.4s; }

    @keyframes eq-center{
      0%  { transform:scaleY(var(--sy-min,.35)); opacity:.92; }
      50% { transform:scaleY(var(--sy-max,.85)); opacity:1;    }
      100%{ transform:scaleY(var(--sy-min,.35)); opacity:.92; }
    }

    :host{
      --media-marquee-speed: var(--media_marquee_speed, 14s);
      --media-marquee-gap: var(--media_marquee_gap, 32px);
      --media-title-line-height: var(--media_title_line_height, 1.35em);
      --media-title-size: var(--media_title_size, calc(var(--badge-font-size-current, 13px) - 1px));
      --media-sub-opacity: .75;
    }

    :host{
      --matte-dim: .045;
      --matte-hi-dim: .065;
      --matte-blur: 30px;
      --matte-sat: 1.62;
      --matte-contrast: 1.16;
      --matte-bright: 1.05;
      --media-wash-a: .15;
      --matte-wash1: .006;
      --matte-wash2: .032;
      --matte-wash3: .024;
      --media-orbit-speed: 30s;
      --media-breathe-speed: 40s;
    }

    :host ha-card::after{
      content:"";
      position:absolute;
      inset:-1px;
      z-index:2;
      pointer-events:none;
      border-radius: inherit;
      -webkit-mask-image: radial-gradient(100% 100% at 50% 50%, #000 calc(100% - 1.5px), transparent 100%);
              mask-image: radial-gradient(100% 100% at 50% 50%, #000 calc(100% - 1.5px), transparent 100%);
      background:
        linear-gradient(rgba(0,0,0,.20), rgba(0,0,0,.20)),
        linear-gradient(90deg,
          rgba(255,255,255,var(--matte-wash1)) 0%,
          rgba(255,255,255,calc(var(--matte-wash1)*1.5)) 50%,
          rgba(255,255,255,var(--matte-wash1)) 100%),
        radial-gradient(120% 70% at 20% -30%,
          rgba(255,255,255,var(--matte-wash2)) 0%,
          rgba(255,255,255,calc(var(--matte-wash2)*.5)) 18%,
          rgba(255,255,255,0) 42%),
        linear-gradient(180deg,
          rgba(255,255,255,var(--matte-wash3)) 16%,
          rgba(255,255,255,0) 68%),
        radial-gradient(120% 160% at 50% 120%, rgba(0,0,0,.03) 0%, rgba(0,0,0,0) 44%),
        radial-gradient(120% 120% at 50% 50%, rgba(255,255,255,.015), rgba(255,255,255,0) 60%),
        linear-gradient(rgba(255,255,255,var(--media-wash-a)), rgba(255,255,255,var(--media-wash-a))),
        var(--bg-url), var(--bg-url), var(--bg-url),
        linear-gradient(rgba(0,0,0,var(--matte-dim)), rgba(0,0,0,var(--matte-dim))),
        linear-gradient(rgba(0,0,0,var(--matte-hi-dim)), rgba(0,0,0,var(--matte-hi-dim)));
      background-blend-mode:
        normal,
        screen, normal, normal,
        normal, normal,
        normal,
        soft-light, color, soft-light,
        multiply,
        soft-light;
      background-repeat: no-repeat;
      filter:
        blur(var(--matte-blur))
        saturate(var(--matte-sat))
        brightness(var(--matte-bright))
        contrast(var(--matte-contrast));
      transform-origin: 50% 50%;
      will-change: background-position, background-size, filter;
      transform: translateZ(0);
      animation:
        orbit   var(--media-orbit-speed, 30s) ease-in-out infinite,
        breathe var(--media-breathe-speed, 40s) ease-in-out infinite;
      animation-play-state: var(--anim-play, running);
    }

    :host::before{
      content:"";
      position:absolute;
      inset:-6px;
      border-radius: calc(var(--badge-br,9999px) + 6px);
      pointer-events:none;
      z-index:4;
      background: var(--bg-url);
      background-size: 240% 240%;
      background-position: 50% 50%;
      filter: blur(var(--rim-blur, 16px)) saturate(1.35) brightness(1.06) contrast(1.06);
      mix-blend-mode: screen;
      padding: calc(var(--badge-rim-width, .55px) + 6px);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
              mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      -webkit-mask-image: radial-gradient(100% 100% at 50% 50%, #000 calc(100% - 1px), transparent 100%);
              mask-image: radial-gradient(100% 100% at 50% 50%, #000 calc(100% - 1px), transparent 100%);
    }

    ha-card::before{
      --rim-w: var(--badge-rim-width, .55px);
      --rim-a: var(--badge-rim-alpha, .14);
      --rim-glow-a: var(--badge-rim-glow, .05);
      --rim-boost: .02;
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      pointer-events:none;
      z-index:5;
      background:none;
      box-shadow:
        inset 0 0 0 var(--rim-w)             rgba(255,255,255,var(--rim-a)),
        inset 0 0 0 calc(var(--rim-w) + 1px) rgba(255,255,255,var(--rim-boost)),
        inset 0 0 12px                       rgba(255,255,255,var(--rim-glow-a));
      outline: 1px solid transparent;
    }

    :host{ --text-shadow-boost: 0 2px 12px rgba(0,0,0,.25); }

    .sub--static,
    .m__inner{
      position: relative;
      isolation: isolate;
      color: color-mix(in oklab, var(--secondary-text-color) 70%, white 30%);
      -webkit-text-fill-color: currentColor;
      mix-blend-mode: screen;
      opacity: var(--media-sub-opacity, .78);
      text-shadow: var(--text-shadow-boost);
      z-index: 3;
    }

    @supports (-webkit-touch-callout: none) {
      :host ha-card::after { box-shadow: none !important; }
    }
