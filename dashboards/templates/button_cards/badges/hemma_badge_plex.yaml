# Plex Badge
hemma_badge_plex:
  template: [hemma_badge_base]
  show_state: false
  show_label: false
  show_entity_picture: true

  tap_action:
    action: more-info
    entity: >
      [[[
        return variables?.session_entity || entity?.entity_id;
      ]]]
  hold_action:
    action: more-info
    entity: >
      [[[
        return variables?.session_entity || entity?.entity_id;
      ]]]

  triggers_update:
    - '[[[ return variables?.session_entity || entity?.entity_id; ]]]'
    - '[[[ return entity?.entity_id; ]]]'

  styles:
    card:
      - padding: 0 14px 0 8px !important
      - background: rgba(0,0,0,0.18) !important
      - -webkit-backdrop-filter: blur(14px) saturate(1.2) !important
      - backdrop-filter: blur(14px) saturate(1.2) !important
      - height: "calc(var(--badge-min-height-current, var(--badge-min-height, 44px)) + 6px) !important"
      - min-height: "calc(var(--badge-min-height-current, var(--badge-min-height, 44px)) + 6px) !important"
      - margin-bottom: var(--badge-row-gap-current, var(--badge-row-gap, 6px)) !important
      - --badge-after-z: 0
      - --badge-before-z: 1

      - display: >
          [[[
            const st = String(entity?.state || 'off').toLowerCase();
            return (st === 'on') ? 'grid' : 'none';
          ]]]

      - --bg-url: >
          [[[
            const cacheKey = '_hemmaPlexBgUrl';
            const sid = variables?.session_entity;
            const a = (sid && hass.states[sid]?.attributes) || {};
            const raw =
              a.image_url ||
              a.entity_picture_local ||
              a.entity_picture ||
              a.media_image_url;

            if (raw) {
              const url = String(raw).startsWith('/') ? `${location.origin}${raw}` : raw;
              const wrapped = `url("${url}")`;
              this[cacheKey] = wrapped;
              return wrapped;
            }
            return this[cacheKey] || 'none';
          ]]]

    grid:
      - grid-template-areas: '"i l"'
      - grid-template-columns: min-content minmax(0, 1fr)
      - column-gap: 6px
      - row-gap: 0
      - align-items: center

    name:
      - grid-area: l
      - padding: 0 8px 0 0 !important
      - min-width: 0
      - max-width: 100%
      - z-index: 3

    icon:
      - display: none

    entity_picture:
      - display: block

  entity_picture: >
    [[[
      const sid = variables?.session_entity;
      const a = (sid && hass.states[sid]?.attributes) || {};
      const raw =
        a.image_url ||
        a.entity_picture_local ||
        a.entity_picture ||
        a.media_image_url;

      if (!raw) return null;
      return String(raw).startsWith('/') ? `${location.origin}${raw}` : raw;
    ]]]

  name: >
    [[[
      const sid = variables?.session_entity;
      const a = (sid && hass.states[sid]?.attributes) || {};
      const plexUser = a.user || 'Unknown';
      const full = a.full_title || a.title || '';
      const esc = (t) => String(t || '').replaceAll('"','&quot;');

      return `
        <div class="mp-wrap">
          <div class="mp-title">Plex â€” ${esc(plexUser)}</div>
          <div class="mp-sub">${esc(full)}</div>
        </div>
      `;
    ]]]

  extra_styles: |
    :host{
      --hemma-mp-img: calc(var(--badge-icon-size-current, var(--badge-icon-size, 36px)) + 4px);
      --hemma-mp-title: var(--badge-font-size-current, var(--badge-font-size, 15px));
      --hemma-mp-sub: calc(var(--hemma-mp-title) - 2px);
    }

    #container > #aspect-ratio{
      width: var(--hemma-mp-img) !important;
      min-width: var(--hemma-mp-img) !important;
      height: var(--hemma-mp-img) !important;
    }

    #img-cell{
      width: var(--hemma-mp-img) !important;
      height: var(--hemma-mp-img) !important;
    }

    :host ha-card::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius: inherit;
      background: var(--bg-url);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: blur(26px) saturate(1.4);
      opacity: .45;
      transform: scale(1.25);
      z-index: 0;
    }

    :host ha-card::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius: inherit;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.18),
        0 0 0 1px rgba(255,255,255,0.06);
      z-index: 1;
    }

    #container{
      height: 100% !important;
      align-items: center !important;
      align-content: center !important;
    }

    #container > #aspect-ratio{
      margin-left: -4px !important;
      margin-right: 8px !important;
      align-self: center !important;
      justify-self: center !important;
      display: block !important;
      line-height: 0 !important;
    }

    #name{
      align-self: center !important;
      display: flex !important;
      align-items: center !important;
    }

    .mp-wrap{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      min-width:0;
      max-width:100%;
      padding-top: 0 !important;
      padding-bottom: 2px !important;
    }

    .mp-title{
      font-size: var(--hemma-mp-title);
      font-weight: 700;
      line-height: 1.14;
      color: rgba(255,255,255,0.96);
      min-width:0;
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow: 0 0 3px rgba(0,0,0,0.25);
    }

    .mp-sub{
      font-size: var(--hemma-mp-sub);
      font-weight: 500;
      line-height: 1.05;
      opacity: .82;
      color: rgba(255,255,255,0.90);
      min-width:0;
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow: 0 0 3px rgba(0,0,0,0.20);
    }

    #img-cell{
      transform: translateY(-0.5px) !important;
    }

    #container > #aspect-ratio{
      margin-left: -4px !important;
      margin-right: 8px !important;
      display: block !important;
      line-height: 0 !important;
      place-self: center !important;
      transform: translateY(-0.5px) !important;
    }

    #name{
      overflow: visible !important;
      padding-block: 2px !important;
      line-height: normal !important;
    }

    #name, #name *{
      overflow: visible !important;
    }

    #container > #aspect-ratio,
    #img-cell,
    #name{
      position: relative !important;
      z-index: 6 !important;
      opacity: 1 !important;
    }

    :host ha-card::after{ z-index: 0 !important; }
    :host ha-card::before{ z-index: 1 !important; }
